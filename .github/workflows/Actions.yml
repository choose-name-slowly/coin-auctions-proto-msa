# gitAction 이 실행할 workflow 를 정의하는 Actions.yml

name:  CI/CD with AWS EC2, ECR

# 이벤트 트리거. deploy 브렌치에 push 될 때 자동실행되는 파이프라인 스크립트
on:
  push:
    branches:
      - deploy

# 모든 Job에서 사용할 환경 변수
env:
  ECR_NAMESPACE: 12jo

# 3개의 job으로 구성
# 1. github 에서 코드를 가져와 Gradle 빌드 (build)
# 2. 그것을 도커 이미지로 빌드하고 ECR에 푸시 (Docker)
# 3. EC2로 접속하여 컨테이너 재실행 (Deploy)

jobs:
  ###################### 1. github 에서 코드를 가져와 Gradle 빌드 (build) #########################
  build:
    name: 프로젝트 빌드하기
    runs-on: ubuntu-latest # github 가 우분투에서 실행시킴
    strategy:
      matrix: # common 은 작업시 같이 빌드된다?
        service: [ com.nameslowly.coinauctions.auction,
                   com.nameslowly.coinauctions.auth,
                   com.nameslowly.coinauctions.bidwin,
                   com.nameslowly.coinauctions.chat,
                   com.nameslowly.coinauctions.coinpay,
                   com.nameslowly.coinauctions.gateway,
                   com.nameslowly.coinauctions.server
        ]

    steps: # 각 job에서 순차적으로 실행될 순서

      # 레포지토리 파일들을 가져옴(v1은 버젼)
      - name: Checkout # 작업 이름(로그에 찍힐 것)
        uses: actions/checkout@v1 # 작업 내용

      # JDK 설정
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      # gradlew 에 파일 실행 권한주기
      - name: Set Gradlew Permission
        run: chmod +x ./gradlew
        working-directory: ${{ matrix.service }}

      # Gradle 빌드
      - name: Build with Gradle
        run: ./gradlew clean build
        working-directory: ${{ matrix.service }}

      # 여기에 테스트를 진행해보자

  ###################### 2. 빌드한 프로젝트들을 도커 이미지로 빌드하고 ECR에 푸시 #########################
  docker:
    name: 도커 이미지로 만들고 ECR 올리기
    needs: build
    runs-on: ubuntu-latest

    steps: # test docker
      - name: Checkout 를 왜 하는거지?
        uses: actions/checkout@v1

      # AWS ECR 에 이미지 업로드 권한을 얻기 위해 인증 진행
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}

      # 로그인
      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v1

      # 작업중 폴더 좀 보자
      - name: List files in current directory
        run: ls -la

      # 혹시모르니 sh 파일에 권한부여해보자
      - name: Make the script executable
        run: chmod +x .github/workflows/dockerTagAndPush.sh

      # 권한 부여 됐나 겸사겸사 볼겸 workflows 들어가보자
      - name: List files in .github/workflows directory
        run: |
          cd .github/workflows
          ls -la
          cd ..
          cd ..

      # docker compose 를 이용해서 여러 이미지를 모두 빌드하고 + 별도의 script를 사용해서 이미지를 push 합니다.
      - name: 도커 이미지로 빌드하자 , Tag and Push docker image to AWS ECR
        run: docker compose -f .github/workflows/Actions-compose.yml build
        env:
          ECR_REGISTRY: ${{ secrets.ECR_REGISTRY }}

      - name: ECR에 태그 달아서 이미지 푸시하자
        run: .github/workflows/dockerTagAndPush.sh
        env:
          ECR_REGISTRY: ${{ secrets.ECR_REGISTRY }}

  ###################### 3. EC2로 접속하여 ECR에서 받은 이미지로 컨테이너 재실행 (Deploy) #########################
  deploy:
    name: EC2 들어가서 배포하기
    needs: docker
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Docker
        uses: actions/checkout@v4

      # 작업중 폴더 좀 보자
      - name: List files in current directory
        run: ls -la

        # 도커 컴포즈를 EC2로 복사
      - name: Copy Docker compose file to EC2
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ubuntu
          key: ${{ secrets.EC2_KEY }}
          source: |
            init.sql
            app-compose.yml
            db-compose.yml
            monitoring-compose.yml
          target: "/home/ubuntu" # target 은 디렉토리임. target directory 아래에 같은 이름의 파일로 옮겨진다.

        # SSH를 통해 EC2 접속하고 컨테이너 재실행
      - name: Deploy to EC2
        uses: appleboy/ssh-action@v1.0.3

        # EC2 접속하는 시크릿 설정
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          AWS_REGION: ${{ secrets.AWS_REGION }}
          ECR_REGISTRY: ${{ secrets.ECR_REGISTRY }}
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ubuntu
          key: ${{ secrets.EC2_KEY }}
          port: 22
          envs: AWS_ACCESS_KEY_ID, AWS_SECRET_ACCESS_KEY, AWS_REGION, ECR_REGISTRY, ECR_NAMESPACE

          # ECR에서 도커 컴포즈에 정의된 이미지들을 가져오는 pull

          script: |
            aws ecr get-login-password --region ${{ secrets.AWS_REGION }} | docker login --username AWS --password-stdin ${{ secrets.ECR_REGISTRY }}
            docker compose -f db-compose down -v
            docker compose -f app-compose down -v
            docker compose -f db-compose pull
            docker compose -f app-compose pull
            docker compose -f db-compose up -d
            sleep 60
            docker compose -f app-compose up -d